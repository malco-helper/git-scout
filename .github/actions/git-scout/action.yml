name: 'Git Scout Analytics'
description: 'Analyze repository activity and post insights to PRs with smart defaults'
author: 'malcohelper'

branding:
  icon: 'activity'
  color: 'blue'

inputs:
  github-token:
    description: 'GitHub token (auto-provided, only required when posting comments or using GitHub API)'
    required: false
    # Note: Cannot use default expressions in composite actions
  
  command:
    description: 'Git Scout command to run (e.g., "stats --since 7d")'
    required: false
    default: 'stats --since 7d'
  
  post-comment:
    description: 'Post results as PR comment (requires github-token)'
    required: false
    default: 'true'
  
  quality-gate:
    description: 'Enable quality gate checks'
    required: false
    default: 'false'
  
  quality-threshold:
    description: 'Minimum quality score (0-100)'
    required: false
    default: '70'
  
  fail-on-quality:
    description: 'Fail the action if quality gate fails'
    required: false
    default: 'false'

outputs:
  stats-json:
    description: 'JSON output of the analysis'
  
  quality-score:
    description: 'Overall quality score (0-100)'
  
  quality-passed:
    description: 'Whether quality gate passed (true/false)'

runs:
  using: 'composite'
  steps:
    - name: Validate Configuration
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Git Scout Configuration Validation"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        POST_COMMENT="${{ inputs.post-comment }}"
        HAS_TOKEN="${{ inputs.github-token != '' }}"
        QUALITY_GATE="${{ inputs.quality-gate }}"
        IS_PR="${{ github.event_name == 'pull_request' }}"
        
        echo "ğŸ“‹ Configuration:"
        echo "  â€¢ Post Comment: $POST_COMMENT"
        echo "  â€¢ Has Token: $HAS_TOKEN"
        echo "  â€¢ Quality Gate: $QUALITY_GATE"
        echo "  â€¢ Event Type: ${{ github.event_name }}"
        echo ""
        
        # Validate token requirement
        if [ "$POST_COMMENT" == "true" ] && [ "$IS_PR" == "true" ] && [ "$HAS_TOKEN" == "false" ]; then
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Configuration Error"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "You enabled post-comment but no GitHub token was provided."
          echo ""
          echo "âœ… Fix Option 1: Add github-token to your workflow:"
          echo "  - uses: malcohelper/git-scout-action@v1"
          echo "    with:"
          echo "      github-token: \\\${{ secrets.GITHUB_TOKEN }}"
          echo ""
          echo "âœ… Fix Option 2: Disable PR comments:"
          echo "  - uses: malcohelper/git-scout-action@v1"
          echo "    with:"
          echo "      post-comment: false"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        fi
        
        # Informational messages
        if [ "$HAS_TOKEN" == "false" ]; then
          echo "â„¹ï¸  Running in local-only mode (no GitHub API access)"
          echo "   â€¢ Analysis will run on local git history"
          echo "   â€¢ No PR comments will be posted"
          echo "   â€¢ Results will be available in logs only"
        else
          echo "âœ… Running with GitHub API access"
          if [ "$POST_COMMENT" == "true" ] && [ "$IS_PR" == "true" ]; then
            echo "   â€¢ Will post analysis to PR comments"
          fi
          if [ "$QUALITY_GATE" == "true" ]; then
            echo "   â€¢ Quality gate enabled (threshold: ${{ inputs.quality-threshold }})"
          fi
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Git Scout
      shell: bash
      run: |
        echo "ğŸ“¦ Installing Git Scout..."
        npm install -g @malcohelper/git-scout 2>/dev/null || npm install -g git-scout || {
          echo "âŒ Failed to install Git Scout"
          echo "Trying alternative installation methods..."
          npm install -g git-scout@latest
        }
        echo "âœ… Git Scout installed successfully"
        git-scout --version || echo "âš ï¸  Warning: Could not verify Git Scout version"
    
    - name: Run Git Scout Analysis
      id: analysis
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ” Running Analysis"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Command: git-scout ${{ inputs.command }} --json"
        echo ""
        
        # Run analysis and capture output
        if git-scout ${{ inputs.command }} --json > /tmp/git-scout-results.json 2>&1; then
          echo "âœ… Analysis completed successfully"
          
          if [ -f /tmp/git-scout-results.json ]; then
            echo "stats-json=$(cat /tmp/git-scout-results.json | jq -c . 2>/dev/null || cat /tmp/git-scout-results.json)" >> $GITHUB_OUTPUT
            echo ""
            echo "ğŸ“Š Results Preview:"
            cat /tmp/git-scout-results.json | jq -C . 2>/dev/null || cat /tmp/git-scout-results.json | head -20
          fi
        else
          echo "âš ï¸  Analysis completed with warnings"
          echo "Check logs above for details"
          # Don't fail - some commands might not produce JSON
          echo "stats-json={}" >> $GITHUB_OUTPUT
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Calculate Quality Score
      id: quality
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š Quality Score Calculation"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
        # Calculate quality score based on stats
        # TODO: Implement real calculation based on metrics
        SCORE=75  # Default score
        
        if [ -f /tmp/git-scout-results.json ]; then
          # Try to calculate from actual data
          COMMITS=$(cat /tmp/git-scout-results.json | jq -r '.totalCommits // 0' 2>/dev/null || echo "0")
          FILES=$(cat /tmp/git-scout-results.json | jq -r '.totalFiles // 0' 2>/dev/null || echo "0")
          
          echo "Metrics:"
          echo "  â€¢ Commits: $COMMITS"
          echo "  â€¢ Files: $FILES"
          
          # Simple scoring logic (can be improved)
          if [ "$COMMITS" -gt "10" ]; then
            SCORE=85
          elif [ "$COMMITS" -gt "5" ]; then
            SCORE=75
          else
            SCORE=65
          fi
        fi
        
        echo ""
        echo "Quality Score: $SCORE/100"
        echo "quality-score=$SCORE" >> $GITHUB_OUTPUT
        
        THRESHOLD=${{ inputs.quality-threshold }}
        if [ "$SCORE" -ge "$THRESHOLD" ]; then
          echo "quality-passed=true" >> $GITHUB_OUTPUT
          echo "âœ… Quality gate passed: $SCORE >= $THRESHOLD"
        else
          echo "quality-passed=false" >> $GITHUB_OUTPUT
          echo "âŒ Quality gate failed: $SCORE < $THRESHOLD"
        fi
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    - name: Post PR Comment
      if: |
        inputs.post-comment == 'true' && 
        github.event_name == 'pull_request' && 
        inputs.github-token != ''
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const statsFile = '/tmp/git-scout-results.json';
          
          console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          console.log('ğŸ’¬ Posting PR Comment');
          console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          
          if (!fs.existsSync(statsFile)) {
            console.log('âš ï¸  No stats file found, creating default comment');
            return;
          }
          
          let stats = {};
          try {
            stats = JSON.parse(fs.readFileSync(statsFile, 'utf8'));
          } catch (error) {
            console.log('âš ï¸  Could not parse stats file:', error.message);
            stats = {};
          }
          
          const qualityScore = '${{ steps.quality.outputs.quality-score }}';
          const qualityPassed = '${{ steps.quality.outputs.quality-passed }}';
          const qualityIcon = qualityPassed === 'true' ? 'âœ…' : 'âŒ';
          
          const comment = `## ğŸ” Git Scout Analysis

**Quality Score**: ${qualityScore}/100 ${qualityIcon}

### ğŸ“Š Repository Statistics

| Metric | Value |
|--------|-------|
| Total Commits | ${stats.totalCommits || 0} |
| Files Changed | ${stats.totalFiles || 0} |
| Lines Added | +${stats.totalAdditions || 0} |
| Lines Removed | -${stats.totalDeletions || 0} |
| Active Authors | ${stats.activeAuthors || 0} |

### ğŸ‘¥ Top Contributors

${stats.authorStats?.slice(0, 5).map(author => 
  `- **${author.name}**: ${author.commits} commits, ${author.filesChanged} files`
).join('\n') || '_No contributor data available_'}

${qualityPassed === 'false' ? `

### âš ï¸ Quality Gate Status

Quality score (${qualityScore}) is below threshold (${{ inputs.quality-threshold }}).

**Recommendations:**
- Review recent changes
- Add more tests
- Improve code documentation
- Check for code smells

` : ''}

---

<sub>Generated by [Git Scout](https://github.com/malcohelper/git-scout) â€¢ [View Full Report](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})</sub>`;
          
          try {
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ” Git Scout Analysis')
            );
            
            if (botComment) {
              console.log('ğŸ“ Updating existing comment');
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              console.log('ğŸ“ Creating new comment');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
            
            console.log('âœ… Comment posted successfully');
          } catch (error) {
            console.log('âŒ Failed to post comment:', error.message);
            core.setFailed(error.message);
          }
          
          console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    - name: Check Quality Gate
      if: inputs.quality-gate == 'true' && steps.quality.outputs.quality-passed == 'false'
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Quality Gate Failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Quality Score: ${{ steps.quality.outputs.quality-score }}/100"
        echo "Threshold: ${{ inputs.quality-threshold }}/100"
        echo ""
        
        if [ "${{ inputs.fail-on-quality }}" == "true" ]; then
          echo "ğŸš« Failing workflow as requested (fail-on-quality: true)"
          echo ""
          echo "To proceed anyway, either:"
          echo "  1. Improve code quality to meet threshold"
          echo "  2. Set fail-on-quality: false"
          echo "  3. Lower quality-threshold value"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
        else
          echo "âš ï¸  Quality gate failed but not blocking workflow"
          echo "   (fail-on-quality is set to false)"
          echo ""
          echo "Consider setting fail-on-quality: true to enforce quality standards"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
    
    - name: Summary
      if: always()
      shell: bash
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“‹ Git Scout Action Summary"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Quality Score: ${{ steps.quality.outputs.quality-score }}/100"
        echo "Quality Passed: ${{ steps.quality.outputs.quality-passed }}"
        echo ""
        echo "ğŸ“– Documentation: https://github.com/malcohelper/git-scout"
        echo "ğŸ› Issues: https://github.com/malcohelper/git-scout/issues"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
